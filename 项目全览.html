<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drug Repurposing - 项目全览</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif; background: #f5f5f7; color: #1d1d1f; line-height: 1.6; padding: 16px; padding-bottom: 80px; }
h1 { font-size: 24px; text-align: center; padding: 20px 0 8px; }
.subtitle { text-align: center; color: #86868b; font-size: 14px; margin-bottom: 24px; }
h2 { font-size: 18px; color: #fff; background: linear-gradient(135deg, #0071e3, #40a0ff); padding: 12px 16px; border-radius: 12px 12px 0 0; margin-top: 24px; }
h2.dir-a { background: linear-gradient(135deg, #e84393, #fd79a8); }
h2.dir-b { background: linear-gradient(135deg, #00b894, #55efc4); color: #1d1d1f; }
h3 { font-size: 15px; color: #0071e3; margin: 16px 0 8px; padding-left: 4px; border-left: 3px solid #0071e3; padding-left: 10px; }
.card { background: #fff; border-radius: 0 0 12px 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.card-full { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.step { margin-bottom: 14px; padding: 12px; background: #f9f9fb; border-radius: 10px; border-left: 4px solid #0071e3; }
.step-num { display: inline-block; background: #0071e3; color: #fff; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; font-size: 12px; font-weight: 700; margin-right: 6px; }
.step-title { font-weight: 600; font-size: 14px; display: inline; }
.step-desc { font-size: 13px; color: #424245; margin-top: 6px; }
.io { font-size: 12px; color: #86868b; margin-top: 4px; }
.io b { color: #1d1d1f; }
.tag { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-right: 4px; margin-top: 4px; }
.tag-in { background: #e8f5e9; color: #2e7d32; }
.tag-out { background: #fff3e0; color: #e65100; }
.tag-api { background: #e3f2fd; color: #1565c0; }
.tag-r { background: #fce4ec; color: #c62828; }
.tag-py { background: #e8eaf6; color: #283593; }
.tag-llm { background: #f3e5f5; color: #6a1b9a; }
.tag-file { background: #e0f2f1; color: #00695c; font-family: "SF Mono", monospace; font-size: 10px; }
.flow { background: #1d1d1f; color: #fff; border-radius: 12px; padding: 16px; margin: 16px 0; font-family: "SF Mono", "Menlo", monospace; font-size: 11px; line-height: 1.8; overflow-x: auto; white-space: pre; }
.flow-light { background: #f0f0f5; color: #1d1d1f; border-radius: 12px; padding: 16px; margin: 16px 0; font-family: "SF Mono", "Menlo", monospace; font-size: 11px; line-height: 1.7; overflow-x: auto; white-space: pre; }
.highlight { background: #fffde7; border-left: 4px solid #fdd835; padding: 10px 12px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 13px; }
.highlight-pink { background: #fce4ec; border-left: 4px solid #e84393; padding: 10px 12px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 13px; }
.highlight-green { background: #e8f5e9; border-left: 4px solid #00b894; padding: 10px 12px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 13px; }
.section-intro { font-size: 13px; color: #424245; margin-bottom: 12px; }
.divider { height: 1px; background: #e5e5ea; margin: 20px 0; }
.module-label { display: inline-block; font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px; margin-bottom: 8px; }
.ml-1 { background: #0071e3; color: #fff; }
.ml-2 { background: #34c759; color: #fff; }
.ml-3 { background: #ff9500; color: #fff; }
.ml-4 { background: #af52de; color: #fff; }
.ml-a { background: #e84393; color: #fff; }
.ml-b { background: #00b894; color: #fff; }
table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 8px 0; }
th { background: #f5f5f7; padding: 8px 6px; text-align: left; font-weight: 600; }
td { padding: 8px 6px; border-bottom: 1px solid #e5e5ea; }
.toc { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.toc a { color: #0071e3; text-decoration: none; display: block; padding: 6px 0; font-size: 14px; border-bottom: 1px solid #f5f5f7; }
.toc a:last-child { border-bottom: none; }
.toc .indent { padding-left: 20px; font-size: 13px; color: #86868b; }
.compare-box { display: flex; gap: 8px; margin: 12px 0; }
.compare-col { flex: 1; padding: 12px; border-radius: 10px; font-size: 12px; }
.compare-a { background: #fce4ec; border: 1px solid #f8bbd0; }
.compare-b { background: #e8f5e9; border: 1px solid #c8e6c9; }
.compare-col b { display: block; margin-bottom: 6px; font-size: 13px; }
.file-chain { background: #f5f5f7; border-radius: 10px; padding: 12px; margin: 10px 0; font-size: 12px; }
.file-chain .arrow { color: #0071e3; font-weight: 700; margin: 0 4px; }
</style>
</head>
<body>

<h1>Drug Repurposing Platform</h1>
<p class="subtitle">药物重定位平台 &middot; 项目全览手册<br>支持多疾病 &middot; 双签名源 (dsmeta / ARCHS4)</p>

<!-- 目录 -->
<div class="toc">
  <b style="font-size:15px;">目录</b>
  <a href="#overview">0. 整体架构 &amp; 全局数据流</a>
  <a href="#mod1">1a. dsmeta_signature_pipeline &mdash; 疾病基因签名 (GEO meta 分析)</a>
  <a href="#mod1b">1b. archs4_signature_pipeline &mdash; 疾病基因签名 (ARCHS4 H5)</a>
  <a href="#sig-gate">1c. 签名质量门控 &mdash; 分层质量决策</a>
  <a href="#mod2">2. SigReverse &mdash; 签名反转药物发现</a>
  <a href="#mod3">3. kg_explain &mdash; 知识图谱解释</a>
  <a href="#bridge" class="indent">&nbsp;&nbsp;3.5 Bridge 桥接文件生成 (关键衔接)</a>
  <a href="#mod4">4. LLM+RAG 证据工程 &mdash; 文献证据</a>
  <a href="#dir-ab">5. Direction A vs B &mdash; 两条研究路线详解</a>
  <a href="#postrun">6. 跑完一轮后数据检查</a>
  <a href="#ops">7. 运维工具链 (ops)</a>
  <a href="#dataflow">8. 完整数据流 &amp; 文件清单</a>
  <a href="#summary">9. 速查总结表</a>
</div>

<!-- ==================== 整体架构 ==================== -->
<div id="overview"></div>
<h2>0. 整体架构</h2>
<div class="card">
  <p class="section-intro">整个平台由 <b>5 个子项目</b>串联，从基因表达数据出发，最终产出带文献证据的药物候选清单。<b>签名构建有两个来源</b>（dsmeta / ARCHS4），由 <code>SIG_PRIORITY</code> 控制优先级和回退。kg_explain 产出<b>两个 bridge 文件</b>，分裂成两条并行研究路线。</p>

<div class="flow">      GEO 数据集 (GSE)              ARCHS4 H5 (全平台)
            │                              │
            ▼                              ▼
  ┌────────────────────┐     ┌────────────────────────┐
  │  1a. dsmeta        │     │  1b. archs4_signature  │  Python
  │  R + Python        │     │  GEO样本搜索 → DESeq2  │
  │  多GSE DE → meta   │     │  → meta分析 → 签名     │
  └─────────┬──────────┘     └──────────┬─────────────┘
            │                           │
            └─────────┬─────────────────┘
                      │ SIG_PRIORITY 选择 (dsmeta-first / archs4-first)
                      ▼
            ┌───────────────────┐
            │  签名质量门控      │ min(up,down)≥10 &amp; total≥30
            │  分层: &lt;30 跳过   │ 30-80 收紧 / ≥100 全量
            └─────────┬─────────┘
                      │ sigreverse_input.json
                      ▼
               ┌────────────────────┐
               │  2. SigReverse     │  Python
               │                    │  LINCS L1000 反查
               └─────────┬──────────┘
                         │ drug_reversal_rank.csv
                         ▼
               ┌────────────────────┐
               │  3. kg_explain     │  Python
               │  Drug→Target→      │  知识图谱 10步 + V5排名
               │  Pathway→Disease   │
               └────┬──────────┬────┘
                    │          │
          ┌─────────┘          └──────────┐
          ▼                               ▼
 bridge_repurpose_cross.csv    bridge_origin_reassess.csv
   (全疾病最优药物)               (原疾病方向药物)
          │                               │
          ▼                               ▼
┌──────────────────┐          ┌──────────────────┐
│  Direction A     │          │  Direction B     │
│  跨疾病迁移       │          │  原疾病重评估     │
│  LLM+RAG Step6-9│          │  LLM+RAG Step6-9│
└────────┬─────────┘          └────────┬─────────┘
         │                             │
         ▼                             ▼
  跨疾病候选清单               原疾病候选清单
  + 验证方案                   + 验证方案</div>

  <div class="highlight">
    <b>两种药物来源 (kg_explain 的输入模式)：</b><br>
    <b>Mode A (CT.gov)</b>: 从动脉粥样硬化的失败临床试验出发<br>
    <b>Mode B (Signature)</b>: 从疾病基因签名出发，反查作用于签名基因的药物<br><br>
    <b>两条研究路线 (LLM+RAG 的输出方向)：</b><br>
    <b>Direction A (跨疾病)</b>: 药物在<b>任何</b>疾病中得分最高 → 能否迁移到目标疾病？<br>
    <b>Direction B (原疾病)</b>: 药物在<b>目标疾病</b>本身的机制得分 → 是否值得重新评估？
  </div>
</div>

<!-- ==================== 模块 1a: dsmeta ==================== -->
<div id="mod1"></div>
<h2>1a. dsmeta_signature_pipeline</h2>
<div class="card">
  <span class="module-label ml-1">疾病基因签名构建</span>
  <p class="section-intro">从 GEO 公共数据库下载多组疾病基因表达数据，做差异表达分析 + 跨研究 meta 分析，输出上调/下调各 300 个基因的疾病签名。</p>

  <div class="step">
    <span class="step-num">1</span><span class="step-title">fetch_geo &mdash; 下载 GEO 数据</span>
    <span class="tag tag-r">R</span>
    <p class="step-desc">根据配置的 GSE ID 列表（如 GSE28829, GSE43292），从 NCBI GEO 下载表达矩阵和样本信息。自动选择最大平台，支持本地缓存。</p>
    <p class="io"><span class="tag tag-in">IN</span> GSE ID 列表 (配置文件) <span class="tag tag-out">OUT</span> expr.tsv + pheno.tsv (每个 GSE)</p>
  </div>

  <div class="step">
    <span class="step-num">2</span><span class="step-title">de_limma &mdash; 差异表达分析</span>
    <span class="tag tag-r">R</span>
    <p class="step-desc">对每个 GSE 做 limma 差异表达。正则匹配 case/control 样本，PCA 异常值剔除，输出 logFC / t-stat / p-value。</p>
    <p class="io"><span class="tag tag-in">IN</span> expr.tsv + pheno.tsv <span class="tag tag-out">OUT</span> de.tsv (每个 GSE)</p>
  </div>

  <div class="step">
    <span class="step-num">3</span><span class="step-title">probe_to_gene &mdash; 探针映射到基因 (关键!)</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">不同芯片平台用不同探针 ID，必须统一映射到 HGNC 基因符号。否则跨平台重叠率 0%，映射后 → 74.6%。</p>
    <p class="io"><span class="tag tag-in">IN</span> de.tsv (探针 ID) <span class="tag tag-out">OUT</span> de.tsv (基因符号)</p>
  </div>

  <div class="step">
    <span class="step-num">4</span><span class="step-title">meta_effects &mdash; 跨研究 Meta 分析</span>
    <span class="tag tag-r">R</span>
    <p class="step-desc">用 metafor 随机效应模型合并多个 GSE 的差异表达结果。输出 meta logFC、z 值、FDR、异质性 I&sup2;、方向一致性（&ge;70%）。</p>
    <p class="io"><span class="tag tag-in">IN</span> 所有 GSE 的 de.tsv <span class="tag tag-out">OUT</span> gene_meta.tsv</p>
  </div>

  <div class="step">
    <span class="step-num">5</span><span class="step-title">rank_aggregate &mdash; 排名聚合</span>
    <span class="tag tag-py">Python</span> <span class="tag tag-r">R</span>
    <p class="step-desc">用 RobustRankAggreg (RRA) 做基于排名的聚合，与 meta 分析互补。集成得分 = 70% meta + 30% RRA。</p>
    <p class="io"><span class="tag tag-out">OUT</span> gene_meta_ensemble.tsv</p>
  </div>

  <div class="step">
    <span class="step-num">6</span><span class="step-title">fetch_genesets &mdash; 下载通路基因集</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">从 Reactome / WikiPathways 下载 .gmt 通路基因集文件。</p>
  </div>

  <div class="step">
    <span class="step-num">7</span><span class="step-title">gsea_fgsea &mdash; 基因集富集分析</span>
    <span class="tag tag-r">R</span>
    <p class="step-desc">对每个 GSE 用 fgsea 做通路富集分析 (10,000 次置换)，得到各通路的 NES 富集分数。</p>
  </div>

  <div class="step">
    <span class="step-num">8</span><span class="step-title">pathway_meta &mdash; 通路层 Meta 分析</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">用带符号 Stouffer Z 方法合并各 GSE 的通路富集结果。</p>
  </div>

  <div class="step">
    <span class="step-num">9</span><span class="step-title">make_signature_json &mdash; 生成疾病签名</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">取 top 300 上调 + top 300 下调基因，生成 JSON 签名文件。</p>
    <p class="io"><span class="tag tag-out">OUT</span> sigreverse_input.json + up/down_genes.txt</p>
  </div>

  <div class="step">
    <span class="step-num">10</span><span class="step-title">make_report &mdash; QC 报告</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">生成自包含 HTML 报告：基因统计、FDR 分布、Top 通路等。</p>
  </div>

  <h3>本模块数据流</h3>
<div class="flow-light">GSE28829  GSE43292  ... (GEO 数据集)
    │          │
    ▼          ▼
 expr.tsv   expr.tsv      ← Step 1: 下载
 pheno.tsv  pheno.tsv
    │          │
    ▼          ▼
  de.tsv     de.tsv        ← Step 2: limma 差异表达
 (probes)   (probes)
    │          │
    ▼          ▼
  de.tsv     de.tsv        ← Step 3: 探针→基因符号
 (genes)    (genes)
    │          │
    └────┬─────┘
         ▼
   gene_meta.tsv           ← Step 4: meta 分析
         │
         ▼
 gene_meta_ensemble.tsv    ← Step 5: + RRA 排名
         │
         ▼
 sigreverse_input.json     ← Step 9: 300 up + 300 down
 (交给 SigReverse)</div>
</div>

<!-- ==================== 模块 1b: ARCHS4 ==================== -->
<div id="mod1b"></div>
<h2>1b. archs4_signature_pipeline</h2>
<div class="card">
  <span class="module-label ml-1">疾病基因签名构建 (ARCHS4)</span>
  <p class="section-intro">从 ARCHS4 全平台 H5 文件中搜索疾病相关 GEO 样本，做差异表达 + 跨系列 meta 分析，输出疾病基因签名。不需要预定义 GSE 列表，适合 dsmeta 无法覆盖的罕见疾病。</p>

  <div class="step">
    <span class="step-num">1</span><span class="step-title">search_series &mdash; 关键词搜索 GEO 系列</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">在 ARCHS4 H5 文件的样本元数据中搜索疾病关键词（如 "abdominal aortic aneurysm", "AAA"），自动分配 case/control 标签，按 GEO series 分组。</p>
    <p class="io"><span class="tag tag-in">IN</span> human_gene_v2.4.h5 + 配置 YAML <span class="tag tag-out">OUT</span> series_candidates.json</p>
  </div>

  <div class="step">
    <span class="step-num">2</span><span class="step-title">archs4_select &mdash; 样本选择 &amp; 表达提取</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">从 H5 文件中直接提取选中样本的基因表达矩阵。支持 ARCHS4 v2.4 (<code>meta/genes/symbol</code>) 和旧版 (<code>meta/genes/gene_symbol</code>) 两种路径。每组 min 3 / max 50 样本。</p>
    <p class="io"><span class="tag tag-out">OUT</span> expr_matrix.tsv (每个 series)</p>
  </div>

  <div class="step">
    <span class="step-num">3</span><span class="step-title">de_analysis &mdash; 差异表达 (DESeq2)</span>
    <span class="tag tag-r">R</span>
    <p class="step-desc">对每个 series 做 DESeq2 差异表达分析（ARCHS4 是 count 数据，适合 DESeq2 而非 limma）。</p>
    <p class="io"><span class="tag tag-out">OUT</span> de_results.tsv (每个 series)</p>
  </div>

  <div class="step">
    <span class="step-num">4</span><span class="step-title">meta_analysis &mdash; 跨系列 Meta 分析</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">用 DerSimonian-Laird (DL) 随机效应模型合并多个 series 的差异表达结果，要求方向一致性 &ge; 80%。</p>
    <p class="io"><span class="tag tag-out">OUT</span> meta_results.tsv</p>
  </div>

  <div class="step">
    <span class="step-num">5</span><span class="step-title">make_signature &mdash; 生成签名 JSON</span>
    <span class="tag tag-py">Python</span>
    <p class="step-desc">取 top N 上调 + top N 下调基因（默认 300），按 meta_z &times; OT_score 加权排序，生成与 dsmeta 格式兼容的签名 JSON。</p>
    <p class="io"><span class="tag tag-out">OUT</span> sigreverse_input.json + disease_signature_meta.json</p>
  </div>

  <h3>dsmeta vs ARCHS4 对比</h3>
  <div class="compare-box">
    <div class="compare-col compare-a">
      <b>dsmeta (GEO meta 分析)</b>
      需要预定义 GSE 列表<br>
      芯片+RNA-seq 混合<br>
      limma 差异表达<br>
      适合：有已知 GSE 的常见病<br>
      签名大：300 up + 300 down
    </div>
    <div class="compare-col compare-b">
      <b>ARCHS4 (H5 全平台搜索)</b>
      关键词自动搜索，无需 GSE 列表<br>
      纯 RNA-seq (count data)<br>
      DESeq2 差异表达<br>
      适合：罕见病、新疾病探索<br>
      签名可能较小 (取决于搜到的样本数)
    </div>
  </div>

  <div class="highlight">
    <b>签名源选择 (<code>SIG_PRIORITY</code> 环境变量)：</b><br>
    <code>SIG_PRIORITY=dsmeta</code> (默认) &mdash; 优先 dsmeta，失败回退 ARCHS4<br>
    <code>SIG_PRIORITY=archs4</code> &mdash; 优先 ARCHS4，失败回退 dsmeta<br>
    runner.sh 会自动尝试两个源，成功后打印决策 banner。
  </div>
</div>

<!-- ==================== 签名质量门控 ==================== -->
<div id="sig-gate"></div>
<h2>1c. 签名质量门控</h2>
<div class="card">
  <span class="module-label ml-a">Cross 路线可靠性保障</span>
  <p class="section-intro">ARCHS4 签名可能较小（如 23 up + 30 down = 53 基因），小签名会导致 SigReverse 噪声大、KG 药物爆炸。分层质量门控在两个位置生效：runner.sh（入口门）和 cli.py（KG 内部门）。</p>

  <h3>双重检查条件</h3>
  <table>
    <tr><th>检查项</th><th>条件</th><th>含义</th></tr>
    <tr><td><b>总量检查</b></td><td><code>up + down &ge; 30</code></td><td>基因总数足够覆盖通路</td></tr>
    <tr><td><b>平衡检查</b></td><td><code>min(up, down) &ge; 10</code></td><td>上下调方向均有足够信号</td></tr>
  </table>

  <h3>分层决策</h3>
  <table>
    <tr><th>层级</th><th>条件</th><th>动作</th><th>KG 药物上限</th></tr>
    <tr style="background:#fce4ec;"><td><b>Tier 0</b></td><td>total &lt; 30 或 min(up,down) &lt; 10</td><td>runner.sh 直接跳过 Cross 路线</td><td>N/A</td></tr>
    <tr style="background:#fff3e0;"><td><b>Tier 1</b></td><td>30 &le; total &lt; 100</td><td>Cross 可用，自动收紧</td><td>cap 80</td></tr>
    <tr style="background:#e8f5e9;"><td><b>Tier 2</b></td><td>total &ge; 100</td><td>Cross 正式可用</td><td>cap 200 (默认)</td></tr>
  </table>

  <div class="highlight-pink">
    <b>为什么需要药物上限 (<code>--max-drugs</code>)?</b><br>
    小签名 (如 15 基因) 经 SigReverse 可产生 7000+ 候选药物 → KG 需计算 400K+ DTPD 路径 → 1.6GB jsonl → 内存爆炸 + 30 分钟+。<br>
    药物上限在 KG 入口截断 <code>drug_chembl_map.csv</code>，按 <code>gene_weight</code> 排序保留 top N，从源头控制下游规模。<br>
    环境变量：<code>KG_MAX_DRUGS_SIGNATURE=200</code> (默认 200)
  </div>
</div>

<!-- ==================== 模块 2: SigReverse ==================== -->
<div id="mod2"></div>
<h2>2. SigReverse</h2>
<div class="card">
  <span class="module-label ml-2">签名反转药物发现</span>
  <p class="section-intro">核心假说：如果某药物能"反转"疾病的基因表达模式（上调变下调，下调变上调），那它可能有治疗潜力。基于 LINCS L1000 数据库实现 CMap 方法论。</p>

  <div class="step">
    <span class="step-num">1</span><span class="step-title">加载 &amp; 验证疾病签名</span>
    <p class="step-desc">加载 dsmeta 产出的 JSON 签名，验证基因数（推荐 150-300 个/方向）。</p>
    <p class="io"><span class="tag tag-in">IN</span> sigreverse_input.json</p>
  </div>

  <div class="step">
    <span class="step-num">2</span><span class="step-title">基因符号 → LINCS UUID 映射</span>
    <span class="tag tag-api">LDP3 API</span>
    <p class="step-desc">把基因符号转为 LINCS 数据库中的实体 UUID，记录缺失基因。</p>
  </div>

  <div class="step">
    <span class="step-num">3</span><span class="step-title">LINCS L1000 富集查询</span>
    <span class="tag tag-api">LDP3 API</span>
    <p class="step-desc">查询 L1000 数据库，获取 Top 10,000 个与疾病签名最相关的药物-细胞系-剂量-时间签名，返回 z-up / z-down 分数。</p>
  </div>

  <div class="step">
    <span class="step-num">4</span><span class="step-title">获取签名元数据</span>
    <span class="tag tag-api">LDP3 API</span>
    <p class="step-desc">为每条签名拉取实验上下文：药物名、细胞系、剂量、处理时间。</p>
  </div>

  <div class="step">
    <span class="step-num">5</span><span class="step-title">签名级别打分 (WTCS-like)</span>
    <p class="step-desc">如果 z_up 和 z_down 同向 → 有效分数，否则 → 0。分类为 reverser（反转者）/ mimicker（模仿者）/ partial / orthogonal。</p>
  </div>

  <div class="step">
    <span class="step-num">6</span><span class="step-title">药物级别聚合 (Robustness)</span>
    <p class="step-desc">同一药物的多条签名聚合为一个分数：<br>
    <b>final = median &times; p_reverser &times; log(1+n)/log(1+8) &times; cl_bonus</b><br>
    考虑一致性、样本量饱和、多细胞系多样性。</p>
  </div>

  <div class="step">
    <span class="step-num">7</span><span class="step-title">统计显著性检验</span>
    <p class="step-desc">1000 次置换检验 → 经验 p 值 → BH FDR 校正 + 2000 次 Bootstrap CI。</p>
  </div>

  <div class="step">
    <span class="step-num">8</span><span class="step-title">CMap 四阶段管线</span>
    <p class="step-desc">经典 CMap：ES → WTCS → NCS（细胞系内标准化）→ Tau（-100 到 +100）。<br>Tau &lt; -90 = 强反转候选。</p>
  </div>

  <div class="step">
    <span class="step-num">9</span><span class="step-title">剂量-反应分析</span>
    <p class="step-desc">Spearman 相关分析药物剂量依赖性，评为 excellent / good / marginal / poor。</p>
  </div>

  <div class="step">
    <span class="step-num">10</span><span class="step-title">药物名标准化（可选）</span>
    <span class="tag tag-api">PubChem / UniChem</span>
    <p class="step-desc">LINCS 药物名 → PubChem CID → InChIKey → ChEMBL/DrugBank 交叉引用。</p>
  </div>

  <div class="step">
    <span class="step-num">11</span><span class="step-title">QC &amp; 毒性标记</span>
    <p class="step-desc">检测可能的非特异性毒性反应假阳性（太多签名一致反转 → 可能是细胞应激）。</p>
  </div>

  <div class="step">
    <span class="step-num">12</span><span class="step-title">多源融合排名（可选）</span>
    <p class="step-desc">融合 SigReverse (50%) + KG 机制 (30%) + FAERS 安全性 (10%) + 剂量响应 + 文献。</p>
    <p class="io"><span class="tag tag-out">OUT</span> drug_reversal_rank.csv + fusion_ranking.csv</p>
  </div>

  <h3>本模块数据流</h3>
<div class="flow-light">sigreverse_input.json (300 up + 300 down 基因)
         │
    ┌────┴────┐
    ▼         ▼
 up 基因   down 基因
    │         │
    ▼         ▼
 LINCS UUID  LINCS UUID     ← Step 2: 基因→UUID
    │         │
    └────┬────┘
         ▼
 Top 10,000 签名 (z-up, z-down)  ← Step 3: LINCS 查询
         │
         ▼
 + 元数据 (药物, 细胞系, 剂量)    ← Step 4
         │
         ▼
 sig_score per 签名              ← Step 5: WTCS 打分
         │
         ▼
 final_reversal_score per 药物   ← Step 6: 聚合
         │
         ├── perm_pvalue + fdr   ← Step 7: 显著性
         ├── tau (-100~+100)     ← Step 8: CMap
         ├── dr_quality          ← Step 9: 剂量反应
         │
         ▼
 drug_reversal_rank.csv          ← 最终输出
 (交给 kg_explain)</div>
</div>

<!-- ==================== 模块 3: kg_explain ==================== -->
<div id="mod3"></div>
<h2>3. kg_explain</h2>
<div class="card">
  <span class="module-label ml-3">知识图谱解释引擎</span>
  <p class="section-intro">构建 Drug → Target → Pathway → Disease 的多跳路径，用知识图谱解释药物为什么可能对某疾病有效。支持两种输入模式。</p>

  <h3>Mode A: 从 CT.gov 失败试验出发</h3>

  <div class="step">
    <span class="step-num">1</span><span class="step-title">获取 CT.gov 失败试验</span>
    <span class="tag tag-api">CT.gov API</span>
    <p class="step-desc">查询动脉粥样硬化的被终止/撤回/暂停临床试验，提取药物名称。</p>
    <p class="io"><span class="tag tag-out">OUT</span> failed_trials_drug_rows.csv</p>
  </div>

  <div class="step">
    <span class="step-num">2</span><span class="step-title">RxNorm 标准化</span>
    <span class="tag tag-api">RxNorm API</span>
    <p class="step-desc">用 RxNorm 统一药物名称拼写和别名。</p>
    <p class="io"><span class="tag tag-out">OUT</span> drug_rxnorm_map.csv</p>
  </div>

  <div class="step">
    <span class="step-num">3</span><span class="step-title">构建规范名</span>
    <p class="step-desc">合并别名，创建唯一规范药物名。</p>
    <p class="io"><span class="tag tag-out">OUT</span> drug_canonical.csv</p>
  </div>

  <div class="step">
    <span class="step-num">4</span><span class="step-title">ChEMBL 映射</span>
    <span class="tag tag-api">ChEMBL API</span>
    <p class="step-desc">药物名 → ChEMBL ID（精确 → 模糊 → 盐→母体回退）。</p>
    <p class="io"><span class="tag tag-out">OUT</span> drug_chembl_map.csv</p>
  </div>

  <div class="step">
    <span class="step-num">5</span><span class="step-title">获取药物靶点</span>
    <span class="tag tag-api">ChEMBL API</span>
    <p class="step-desc">从 ChEMBL 机制数据获取每个药物的蛋白靶点。</p>
    <p class="io"><span class="tag tag-out">OUT</span> edge_drug_target.csv</p>
  </div>

  <h3>Mode B: 从基因签名出发</h3>
  <div class="step" style="border-left-color: #34c759;">
    <span class="step-num" style="background:#34c759;">1</span><span class="step-title">基因签名 → 药物反查</span>
    <span class="tag tag-api">ChEMBL + MyGene</span>
    <p class="step-desc">取 top 100 签名基因 → UniProt → ChEMBL 靶点 → 反查作用于这些靶点的药物（Phase II+）。直接产出 Steps 1-5 的等效输出。</p>
  </div>

  <h3>共享步骤 (两种模式共用)</h3>

  <div class="step">
    <span class="step-num">6</span><span class="step-title">靶点 → Ensembl 基因 ID</span>
    <span class="tag tag-api">ChEMBL + UniProt</span>
    <p class="step-desc">ChEMBL 靶点 → UniProt → Ensembl 基因 ID。</p>
    <p class="io"><span class="tag tag-out">OUT</span> target_xref.csv</p>
  </div>

  <div class="step">
    <span class="step-num">7</span><span class="step-title">靶点 → 通路 (Reactome)</span>
    <span class="tag tag-api">Reactome API</span>
    <p class="step-desc">查询每个蛋白参与的生物通路。</p>
    <p class="io"><span class="tag tag-out">OUT</span> edge_target_pathway_all.csv</p>
  </div>

  <div class="step">
    <span class="step-num">8</span><span class="step-title">基因 → 疾病 (OpenTargets)</span>
    <span class="tag tag-api">OpenTargets GraphQL</span>
    <p class="step-desc">查询每个基因关联的疾病（过滤 GO_/MP_ 非疾病条目）。</p>
    <p class="io"><span class="tag tag-out">OUT</span> edge_target_disease_ot.csv</p>
  </div>

  <div class="step">
    <span class="step-num">9</span><span class="step-title">构建中间边</span>
    <p class="step-desc">gene→pathway 边 + pathway→disease 边 + trial→AE 边</p>
  </div>

  <div class="step">
    <span class="step-num">10</span><span class="step-title">V5 额外数据</span>
    <span class="tag tag-api">FAERS + OpenTargets + ChEMBL</span>
    <p class="step-desc">FAERS 不良反应 + 疾病表型关联 + 药物已知适应症</p>
  </div>

  <div class="divider"></div>

  <div class="step" style="border-left-color: #ff9500;">
    <span class="step-num" style="background:#ff9500;">R</span><span class="step-title">V5 排名打分 (2026-02-26 更新)</span>
    <p class="step-desc">生成 Drug→Target→Pathway→Disease 全路径，计算：<br>
    <b>final = mechanism_score &times; e<sup>-(w1&times;safety_penalty - w2&times;trial_penalty)</sup> &times; (1 + w3&times;phenotype_boost)</b><br>
    权重：w1=0.3, w2=0.2, w3=0.1</p>
    <table style="margin:8px 0;font-size:0.92em;">
      <tr><th>子项</th><th>来源</th><th>公式</th></tr>
      <tr><td><b>mechanism_score</b></td><td>V3 路径聚合 (Drug→Target→Pathway→Disease)</td><td>base score</td></tr>
      <tr><td><b>safety_penalty</b></td><td>FAERS 不良反应信号，PRR 过滤</td><td><code>tanh(log1p(PRR)/5 &times; confidence &times; serious_weight)</code></td></tr>
      <tr><td><b>trial_penalty</b></td><td>失败试验，对数饱和</td><td><code>0.1 &times; log1p(safety_stops) + 0.05 &times; log1p(eff_stops)</code></td></tr>
      <tr><td><b>phenotype_boost</b></td><td>疾病表型重叠</td><td><code>avg_pheno_score &times; log1p(n_phenotype)</code></td></tr>
    </table>
    <p class="step-desc">Bootstrap CI (1000x) 量化不确定性。组合药按成分数归一化，避免分数膨胀。</p>
    <p class="io"><span class="tag tag-out">OUT</span> drug_disease_rank.csv + evidence_pack/*.json (仅 top-K)</p>
  </div>

  <h3>本模块数据流</h3>
<div class="flow-light">Mode A: CT.gov 失败试验        Mode B: 基因签名
         │                              │
  Step1: CT.gov API              Step1: 签名基因→UniProt
         │                        →ChEMBL靶点→反查药物
  Step2: RxNorm 标准化                  │
         │                              │
  Step3: 规范名                         │
         │                              │
  Step4: ChEMBL 映射                    │
         │                              │
  Step5: 获取靶点                       │
         │                              │
         └──────────┬───────────────────┘
                    │
                    ▼
          edge_drug_target.csv (药物-靶点边)
                    │
                    ▼
          Step6: ChEMBL→UniProt→Ensembl
                    │
                    ▼
          target_xref.csv (靶点交叉引用)
                    │
             ┌──────┴──────┐
             ▼             ▼
     Step7: Reactome   Step8: OpenTargets
     靶点→通路          基因→疾病
             │             │
             ▼             ▼
  edge_target_pathway  edge_target_disease
             │             │
             └──────┬──────┘
                    ▼
          Step9: 构建中间边
          ├── edge_gene_pathway.csv
          ├── edge_pathway_disease.csv
          └── edge_trial_ae.csv
                    │
                    ▼
          Step10: V5 额外数据
          ├── edge_drug_ae_faers.csv    (FAERS)
          ├── edge_disease_phenotype.csv (表型)
          └── drug_known_indications.csv (适应症)
                    │
                    ▼
          ┌──────────────────────────────────────────┐
          │  V5 排名打分                              │
          │  final = mechanism × exp(-安全罚-试验罚)    │
          │         × (1 + 表型加成)                   │
          │  安全罚: tanh(log1p(PRR)/5 × conf × wt)   │
          │  试验罚: 0.1·log1p(safe) + 0.05·log1p(eff)│
          │  表型:   avg_score × log1p(n_pheno)        │
          │  54,000+ 药物-疾病对 + Bootstrap CI         │
          └───────────────────┬────────────────────────┘
                         │
                    ┌────┴────┐
                    ▼         ▼
         bridge_repurpose  bridge_origin
         _cross.csv        _reassess.csv
         (→Dir A)          (→Dir B)</div>
</div>

<!-- ==================== 3.5 Bridge 桥接文件 ==================== -->
<div id="bridge"></div>
<h2 style="background: linear-gradient(135deg, #ff9500, #ffbe76);">3.5 Bridge 桥接文件生成</h2>
<div class="card">
  <p class="section-intro">kg_explain 的 V5 排名会产出 <b>54,000+</b> 个药物-疾病对。这些结果需要分裂成两个 bridge 文件，分别送入 LLM+RAG 的两条研究路线。<b>这是连接 kg_explain 和 LLM+RAG 的关键衔接点。</b></p>

  <div class="step" style="border-left-color: #e84393;">
    <span class="step-num" style="background:#e84393;">A</span><span class="step-title">bridge_repurpose_cross.csv</span>
    <p class="step-desc">
      <b>生成逻辑：</b>对每个药物，取它在<b>所有疾病</b>中得分最高的那个疾病对。<br>
      <b>含义：</b>这个药物在其他疾病上有很强的机制解释 → 能否"迁移"到我们的目标疾病？<br>
      <b>举例：</b>emricasan 在"智力发育障碍"中得分 11.4 → 它的 caspase 抑制机制能否治疗动脉粥样硬化？<br>
      <b>典型药物来源：</b>JAK 抑制剂（自免）、BTK 抑制剂（肿瘤）等跨领域药物
    </p>
    <p class="io"><span class="tag tag-file">kg_explain/output/bridge_repurpose_cross.csv</span></p>
  </div>

  <div class="step" style="border-left-color: #00b894;">
    <span class="step-num" style="background:#00b894;">B</span><span class="step-title">bridge_origin_reassess.csv</span>
    <p class="step-desc">
      <b>生成逻辑：</b>只看药物在<b>目标疾病（动脉粥样硬化）</b>及其亚型中的得分。用 MAX 聚合。<br>
      <b>含义：</b>这些药物之前在动脉粥样硬化试验中失败了，但机制得分还不错 → 值得重新评估？<br>
      <b>举例：</b>digitoxin 在"冠状动脉粥样硬化"中得分 1.02 → 该药是否因错误终点/人群而失败？<br>
      <b>额外功能：</b>支持通过 --inject YAML 手动注入文献中发现但不在 KG 中的药物<br>
      <b>额外字段：</b>ci_lower, ci_upper, confidence_tier, source (kg/literature/kg+literature)
    </p>
    <p class="io"><span class="tag tag-file">kg_explain/output/bridge_origin_reassess.csv</span></p>
  </div>

  <h3>Bridge CSV 靶点列 (2026-02-16 新增)</h3>
  <div class="highlight">
    <b>两个 bridge 文件现在都包含靶点和结构信息：</b><br><br>
    <b>targets</b> — 人类可读靶点摘要（分号分隔），示例：<br>
    <span style="font-family:monospace;font-size:11px;background:#f5f5f7;padding:2px 6px;border-radius:4px;">PCSK9 (CHEMBL2929) [UniProt:Q8NBP7] [PDB+AlphaFold] — Subtilisin/kexin type 9 inhibitor</span><br><br>
    <b>target_details</b> — JSON 数组，每个靶点包含：
    <table>
      <tr><th>字段</th><th>说明</th></tr>
      <tr><td>target_chembl_id</td><td>ChEMBL 靶点 ID</td></tr>
      <tr><td>target_name</td><td>靶点名称</td></tr>
      <tr><td>mechanism_of_action</td><td>作用机制</td></tr>
      <tr><td>uniprot</td><td>UniProt 登录号</td></tr>
      <tr><td>pdb_ids</td><td>前 5 个实验 PDB ID</td></tr>
      <tr><td>pdb_count</td><td>PDB 条目总数</td></tr>
      <tr><td>has_alphafold</td><td>是否有 AlphaFold 预测</td></tr>
      <tr><td>structure_source</td><td>结构来源分类（见下方）</td></tr>
    </table>
    <br>
    <b>structure_source 分类：</b><br>
    <span style="display:inline-block;background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:8px;font-size:11px;margin:2px;">PDB+AlphaFold</span> 有实验 PDB + AlphaFold 预测 → 可直接做分子对接，优先选实验 PDB<br>
    <span style="display:inline-block;background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:8px;font-size:11px;margin:2px;">PDB</span> 仅有实验 PDB → 可直接做分子对接<br>
    <span style="display:inline-block;background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:8px;font-size:11px;margin:2px;">AlphaFold_only</span> 仅 AI 预测结构 → 对接结果需谨慎解读<br>
    <span style="display:inline-block;background:#fce4ec;color:#c62828;padding:2px 8px;border-radius:8px;font-size:11px;margin:2px;">none</span> 无结构数据 → 无法做分子对接<br><br>
    <b>数据来源：</b>edge_drug_target.csv + node_target.csv + target_xref.csv 自动 join
  </div>

  <h3>两个 Bridge 的区别</h3>
  <div class="compare-box">
    <div class="compare-col compare-a">
      <b>Direction A: 跨疾病迁移</b>
      每个药物的<b>全局最优</b>疾病<br>
      ~50 个药物<br>
      来自各种疾病领域<br>
      高风险高回报<br>
      <span class="tag tag-file">bridge_repurpose_cross.csv</span>
    </div>
    <div class="compare-col compare-b">
      <b>Direction B: 原疾病重评估</b>
      只看<b>目标疾病</b>内的得分<br>
      ~83 个药物<br>
      都是动脉粥样硬化相关<br>
      低风险稳健<br>
      <span class="tag tag-file">bridge_origin_reassess.csv</span>
    </div>
  </div>

  <h3>Bridge 生成数据流</h3>
<div class="flow">drug_disease_rank.csv (54,000+ 药物-疾病对)
         │
         │  + edge_drug_target.csv + node_target.csv + target_xref.csv
         │    (自动 join → 靶点名/UniProt/PDB/AlphaFold)
         │
    ┌────┴─────────────────────────┐
    │                              │
    ▼                              ▼
 V5 ranker 内置逻辑             generate_disease_bridge.py
 "每个药物取全局最优疾病"       "只保留目标疾病的行"
    │                              │
    ▼                              ▼
bridge_repurpose_cross.csv    bridge_origin_reassess.csv
 (~50 drugs + 靶点/结构)       (~83 drugs + 靶点/结构)
    │                              │
    ▼                              ▼
 → LLM+RAG Direction A         → LLM+RAG Direction B</div>
</div>

<!-- ==================== 模块 4: LLM+RAG ==================== -->
<div id="mod4"></div>
<h2>4. LLM+RAG 证据工程</h2>
<div class="card">
  <span class="module-label ml-4">文献证据提取与验证</span>
  <p class="section-intro">用 PubMed 文献检索 + 本地 LLM 结构化提取，为候选药物生成文献支持证据，进行多维度打分和门控筛选。<b>Step 0-5 为预处理（仅 CT.gov 模式需要），Step 6-9 为核心流程，且会分别跑 Direction A 和 B 两遍。</b></p>

  <h3>预处理步骤 (仅 CT.gov 模式)</h3>

  <div class="step" style="opacity: 0.7;">
    <span class="step-num">0</span><span class="step-title">构建试验池</span>
    <span class="tag tag-api">CT.gov API</span>
    <p class="step-desc">从种子 NCT ID 列表拉取临床试验详情。</p>
  </div>

  <div class="step" style="opacity: 0.7;">
    <span class="step-num">1-3</span><span class="step-title">获取失败药物</span>
    <p class="step-desc">筛选终止/撤回试验 → 提取药物 → 过滤安慰剂 → 标记结局。</p>
  </div>

  <div class="step" style="opacity: 0.7;">
    <span class="step-num">4</span><span class="step-title">AI 辅助试验标注</span>
    <span class="tag tag-llm">LLM</span>
    <p class="step-desc">AI 预填 + PubMed 补充 + 人工审核。</p>
  </div>

  <div class="step" style="opacity: 0.7;">
    <span class="step-num">5</span><span class="step-title">药物名规范化</span>
    <p class="step-desc">去除剂量词缀 + 模糊去重 (92%) + MD5 哈希 ID。</p>
  </div>

  <h3>核心流程 (Direction A 和 B 各跑一遍)</h3>

  <div class="highlight">
    <b>关键理解：</b>Step 6-9 是同一套代码，但分别用 bridge_repurpose_cross.csv 和 bridge_origin_reassess.csv 作为输入，输出到不同目录。两条路线完全独立、并行。
  </div>

  <div class="step" style="border-left-color: #af52de;">
    <span class="step-num" style="background:#af52de;">6</span><span class="step-title">PubMed RAG + LLM 证据提取 ★ 核心</span>
    <span class="tag tag-api">PubMed</span> <span class="tag tag-llm">Ollama qwen2.5:7b</span>
    <p class="step-desc">
      <b>三阶段检索：</b><br>
      1. PubMed 多路检索（精确疾病 + 终点驱动 + 跨疾病类比）<br>
      2. BM25 排序 → Top 80 → 嵌入语义重排 → Top 30<br>
      3. 本地 LLM 结构化提取：方向 / 模型 / 终点 / 机制 / 置信度<br><br>
      <b>三层幻觉检测：</b>PMID 一致性 + 药物锚定 + 机制锚定<br><br>
      <b>Direction A 输入：</b><span class="tag tag-file">bridge_repurpose_cross.csv</span> → 目标疾病检索<br>
      <b>Direction B 输入：</b><span class="tag tag-file">bridge_origin_reassess.csv</span> → 终点特异性检索
    </p>
    <p class="io"><span class="tag tag-out">OUT</span> dossiers/*.json + step6_rank_v2.csv</p>
  </div>

  <div class="step">
    <span class="step-num">7</span><span class="step-title">多维打分 + 门控</span>
    <p class="step-desc">
      <b>5 维度打分（满分 100）：</b>

      <table>
        <tr><th>维度</th><th>分值</th><th>含义</th></tr>
        <tr><td>证据强度</td><td>0-30</td><td>benefit 文献 &times;2 - harm &times;1</td></tr>
        <tr><td>机制合理性</td><td>0-20</td><td>有机制描述的文献占比</td></tr>
        <tr><td>可转化性</td><td>0-20</td><td>人体研究 + 临床阶段 + 疾病近似度</td></tr>
        <tr><td>安全性</td><td>0-20</td><td>harm 反面 + 黑名单罚分</td></tr>
        <tr><td>可行性</td><td>0-10</td><td>可及性 + 生产可行性</td></tr>
      </table>
      <br>
      <b>门控：</b>硬门控 (benefit&lt;2 / harm&gt;50% / 文献&lt;3 → NO-GO) + 软门控 (&ge;60→GO / 40-60→MAYBE / &lt;40→NO-GO)
    </p>
    <p class="io"><span class="tag tag-out">OUT</span> step7_gating_decision.csv + step7_hypothesis_cards.md</p>
  </div>

  <div class="step">
    <span class="step-num">8</span><span class="step-title">发布门控 + 候选打包 (含靶点/结构信息)</span>
    <p class="step-desc">移除 NO-GO，按总分排序 Top-K，导出 Excel 工作簿。<br><br>
      <b>靶点结构信息 (2026-02-16 新增)：</b>自动从 bridge CSV 读取靶点数据，并输出到：<br>
      &bull; <b>Excel 总表</b> — 增加 targets 列<br>
      &bull; <b>Excel 每药 Sheet</b> — 增加靶点结构表（Target ChEMBL ID / UniProt / 作用机制 / Structure Source / PDB Count / PDB IDs）<br>
      &bull; <b>Markdown one-pager</b> — 增加靶点小节，含 UniProt 链接和 PDB 链接，标注结构来源 badge
    </p>
    <p class="io"><span class="tag tag-out">OUT</span> step8_fusion_rank_report.xlsx ★ 核心交付物 (含靶点结构表)</p>
  </div>

  <div class="step">
    <span class="step-num">9</span><span class="step-title">验证方案生成</span>
    <p class="step-desc">为每个入选药物生成：实验类型、关键问题、读数指标、成功标准、时间、优先级 (P1/P2/P3)。</p>
    <p class="io"><span class="tag tag-out">OUT</span> step9_validation_plan.csv + step9_validation_plan.md</p>
  </div>

  <h3>本模块数据流（双路线）</h3>
<div class="flow">               bridge_repurpose_cross.csv    bridge_origin_reassess.csv
               (来自 kg_explain)              (来自 kg_explain)
                       │                              │
                       ▼                              ▼
              ┌────────────────┐             ┌────────────────┐
              │  Direction A   │             │  Direction B   │
              │  Step 6: RAG   │             │  Step 6: RAG   │
              │  PubMed + LLM  │             │  PubMed + LLM  │
              └───────┬────────┘             └───────┬────────┘
                      ▼                              ▼
              step6_repurpose_cross/          step6_origin_reassess/
              ├── dossiers/*.json            ├── dossiers/*.json
              └── step6_rank_v2.csv          └── step6_rank_v2.csv
                      │                              │
                      ▼                              ▼
              ┌────────────────┐             ┌────────────────┐
              │  Step 7: 打分   │             │  Step 7: 打分   │
              │  5维 + 门控     │             │  5维 + 门控     │
              └───────┬────────┘             └───────┬────────┘
                      ▼                              ▼
              step7_repurpose_cross/          step7_origin_reassess/
              ├── gating_decision.csv        ├── gating_decision.csv
              └── hypothesis_cards.md        └── hypothesis_cards.md
                      │                              │
                      ▼                              ▼
              ┌────────────────┐             ┌────────────────┐
              │  Step 8: 打包   │             │  Step 8: 打包   │
              └───────┬────────┘             └───────┬────────┘
                      ▼                              ▼
              step8_repurpose_cross/          step8_origin_reassess/
              └── fusion_rank_report.xlsx        └── fusion_rank_report.xlsx
                      │                              │
                      ▼                              ▼
              ┌────────────────┐             ┌────────────────┐
              │  Step 9: 验证   │             │  Step 9: 验证   │
              └───────┬────────┘             └───────┬────────┘
                      ▼                              ▼
              step9_repurpose_cross/          step9_origin_reassess/
              └── validation_plan.csv        └── validation_plan.csv

                      │                              │
                      ▼                              ▼
              跨疾病候选清单                原疾病候选清单
              (高风险高回报)               (稳健重评估)</div>
</div>

<!-- ==================== Direction A vs B 详解 ==================== -->
<div id="dir-ab"></div>
<h2 style="background: linear-gradient(135deg, #e84393, #00b894);">5. Direction A vs B 详解</h2>
<div class="card">
  <p class="section-intro">两条路线回答不同的科学问题，使用相同的方法论但输入不同的药物集合。</p>

  <div class="highlight-pink">
    <b>Direction A: 跨疾病迁移 (Repurpose Cross)</b><br><br>
    <b>科学问题：</b>"有没有原本用于<b>其他疾病</b>的药物，其靶点机制恰好也能治疗动脉粥样硬化？"<br><br>
    <b>策略：</b>探索性 (Exploration) — 从未在目标疾病中测试过的药物<br><br>
    <b>药物来源举例：</b><br>
    &bull; JAK 抑制剂（来自自身免疫领域）→ 可能有抗炎作用<br>
    &bull; BTK 抑制剂（来自肿瘤领域）→ 可能抑制巨噬细胞浸润<br>
    &bull; Caspase 抑制剂（来自肝病领域）→ 可能抑制斑块内细胞凋亡<br><br>
    <b>风险收益：</b>高风险 / 高回报 / 高新颖性<br>
    <b>典型候选数：</b>~50 个药物 → 筛到 ~5 个 GO<br><br>
    <b>输入文件：</b><span class="tag tag-file">bridge_repurpose_cross.csv</span><br>
    <b>输出目录：</b>step{6,7,8,9}_repurpose_cross/
  </div>

  <div class="highlight-green">
    <b>Direction B: 原疾病重评估 (Origin Reassess)</b><br><br>
    <b>科学问题：</b>"那些在动脉粥样硬化试验中<b>失败过</b>的药物，是不是因为选错了终点/人群/剂量才失败的？值得再试吗？"<br><br>
    <b>策略：</b>利用性 (Exploitation) — 已有目标疾病数据的药物<br><br>
    <b>药物来源举例：</b><br>
    &bull; Digitoxin — 心脏药物，在冠脉粥样硬化有信号但试验终止<br>
    &bull; Emricasan — caspase 抑制剂，肝病失败但有心血管表型重叠<br>
    &bull; 各种降脂/抗炎药 — 一期成功但二/三期失败<br><br>
    <b>风险收益：</b>低风险 / 中等回报 / 更多已有数据<br>
    <b>典型候选数：</b>~83 个药物 → 筛到 ~10 个 GO<br><br>
    <b>输入文件：</b><span class="tag tag-file">bridge_origin_reassess.csv</span><br>
    <b>输出目录：</b>step{6,7,8,9}_origin_reassess/
  </div>

  <h3>对比总结</h3>
  <table>
    <tr><th></th><th style="color:#e84393;">Dir A: 跨疾病</th><th style="color:#00b894;">Dir B: 原疾病</th></tr>
    <tr><td><b>科学问题</b></td><td>其他疾病的药能否迁移？</td><td>失败的药是否值得重试？</td></tr>
    <tr><td><b>药物池</b></td><td>全局最优得分（任何疾病）</td><td>仅目标疾病内的得分</td></tr>
    <tr><td><b>桥接文件</b></td><td>bridge_repurpose_cross</td><td>bridge_origin_reassess</td></tr>
    <tr><td><b>文献检索策略</b></td><td>跨疾病证据 + 机制类比</td><td>终点特异性 + 临床再分析</td></tr>
    <tr><td><b>典型药物数</b></td><td>~50</td><td>~83</td></tr>
    <tr><td><b>风格</b></td><td>探索性 (Exploration)</td><td>利用性 (Exploitation)</td></tr>
    <tr><td><b>风险</b></td><td>高</td><td>低</td></tr>
    <tr><td><b>新颖性</b></td><td>高</td><td>中</td></tr>
    <tr><td><b>支持文献注入</b></td><td>否</td><td>是 (--inject YAML)</td></tr>
    <tr><td><b>额外字段</b></td><td>基础列 + 靶点/结构</td><td>CI、confidence_tier、source + 靶点/结构</td></tr>
  </table>

  <div class="highlight">
    <b>为什么要两条路线？</b><br>
    这是"探索-利用"(Exploration-Exploitation) 策略的经典应用。Direction A 追求新颖性发现，Direction B 追求稳健再评估。两条路线产出独立的候选清单，最终由研究者根据资源、战略优先级和证据质量综合决策。
  </div>
</div>

<!-- ==================== 跑完一轮后数据检查 ==================== -->
<div id="postrun"></div>
<h2 style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">6. 跑完一轮后数据检查</h2>
<div class="card">
  <p class="section-intro">每次完整运行后，按以下优先级检查关键输出。</p>

  <h3>第一优先：看结论</h3>
  <div class="step" style="border-left-color: #e17055;">
    <span class="step-num" style="background:#e17055;">1</span><span class="step-title">候选药物清单</span>
    <p class="step-desc">
      &bull; 打开 <b>step8_fusion_rank_report.xlsx</b> → Shortlist sheet → 确认候选药数量和 GO/MAYBE/NO-GO 分布<br>
      &bull; 每个药的 Sheet → 检查<b>靶点结构表</b> (Structure Source 列)：<br>
      <span style="display:inline-block;background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:6px;font-size:10px;margin:2px;">PDB+AlphaFold</span> 可直接做分子对接，选实验 PDB
      <span style="display:inline-block;background:#fff3e0;color:#e65100;padding:1px 6px;border-radius:6px;font-size:10px;margin:2px;">AlphaFold_only</span> 对接结果需谨慎解读
      <span style="display:inline-block;background:#fce4ec;color:#c62828;padding:1px 6px;border-radius:6px;font-size:10px;margin:2px;">none</span> 无法做分子对接<br>
      &bull; 查看 <b>step9_validation_plan.csv</b> → 关注 P1 优先级候选药<br>
      &bull; 对比 cross vs origin 两条路线 → 重叠候选药 = 更可信
    </p>
  </div>

  <h3>第二优先：判断可信度</h3>
  <div class="step" style="border-left-color: #fdcb6e;">
    <span class="step-num" style="background:#fdcb6e;color:#1d1d1f;">2</span><span class="step-title">证据评估</span>
    <p class="step-desc">
      &bull; <b>step7_cards.json</b> → 每药 GO/MAYBE/NO-GO 决策 + 5 维打分<br>
      &bull; <b>step8_one_pagers_topK.md</b> → 候选药 Markdown 报告（含靶点/UniProt/PDB 链接）<br>
      &bull; <b>bridge_*.csv</b> → KG 排名 + 靶点信息 + 结构来源标记
    </p>
  </div>

  <h3>第三优先：排查问题</h3>
  <div class="step" style="border-left-color: #74b9ff;">
    <span class="step-num" style="background:#74b9ff;color:#1d1d1f;">3</span><span class="step-title">调试排查</span>
    <p class="step-desc">
      &bull; <b>drug_disease_rank.csv</b> → 某药排名高/低的原因<br>
      &bull; <b>poolA_drug_level.csv</b> → CT.gov 拉到了哪些药<br>
      &bull; <b>manual_review_queue.csv</b> → 需人工确认的试验<br>
      &bull; <b>step6 dossiers/*.json</b> → 某药的 PubMed 证据原文<br>
      &bull; <b>run_summary.json</b> → 运行是否有步骤失败/被隔离
    </p>
  </div>

  <div class="highlight">
    <b>详细审核流程</b>请参考 <span style="font-family:monospace;font-size:11px;">RUN_REVIEW_CHECKLIST.md</span>，含 release gate 阈值（kill_rate &le; 0.15, miss_rate &le; 0.10, IRR kappa &ge; 0.60）和泄漏审计要求。
  </div>
</div>

<!-- ==================== 运维工具链 ==================== -->
<div id="ops"></div>
<h2 style="background: linear-gradient(135deg, #636e72, #b2bec3);">7. 运维工具链 (ops)</h2>
<div class="card">
  <p class="section-intro">从 GEO 数据集自动发现到一键启动管线的完整工具链。解决了之前需要手动查 GEO、手动写 config、手动建 venv 的痛点。<b>2026-02-26 更新</b>：runner.sh 现在<b>全自动</b>为新疾病生成签名 config（GEO → dsmeta config → ARCHS4 fallback），无需任何手动配置。</p>

  <h3>工具链概览</h3>
  <div class="highlight-green">
    <b>🆕 全自动模式 (2026-02-26)：</b>只需在 disease list 加一行（disease_key | disease_query | EFO_ID），<code>bash ops/start.sh start</code> 即可自动跑 Cross + Origin 双路线。runner.sh 的 <code>ensure_cross_signature_config()</code> 会自动为新疾病生成签名 config。
  </div>
<div class="flow-light">runner.sh ensure_cross_signature_config()     ← 全自动（新疾病无需手动配置）
│
├─ 已有 dsmeta 或 ARCHS4 config?  → 跳过
│
├─ ① auto_discover_geo.py 搜 NCBI GEO
│     → 找到 GSE → generate_dsmeta_configs.py → dsmeta config ✅
│
└─ ② GEO 失败 → archs4/scripts/auto_generate_config.py
      → 用 DISEASE_KEYWORD_MAP + EFO ID → ARCHS4 config ✅
      → 也失败 → skip Cross → Origin 照跑

然后进入 run_cross_route()，按 SIG_PRIORITY 顺序运行:
  dsmeta pipeline  →  失败 → fallback →  ARCHS4 pipeline  →  都失败 → skip Cross</div>

  <h3>手动精细控制工具链（可选）</h3>
<div class="flow-light">auto_discover_geo.py  ──→  AI 辅助审核  ──→  generate_dsmeta_configs.py  ──→  start.sh
│                         │                  │                               │
│ 搜 NCBI GEO             │ 喂 discovery_log │ 读取 selected.tsv             │ 环境检查
│ 过滤 + 打分              │ 给 Claude/GPT    │ 生成 dsmeta YAML              │ 安装 venv
│ 自动检测 case/control    │ 检查 6 项质量    │ 更新 disease_list_dual.txt    │ 启动 24/7 runner
│                         │ 编辑 YAML 移除   │                               │
▼                         ▼                  ▼                               ▼
geo_curation/<disease>/   审核后的 YAML      dsmeta/configs/<disease>.yaml   nohup background
├── candidates.tsv        (移除不合格 GSE)   (ready for pipeline)            + log + PID 管理
├── selected.tsv
├── discovery_log.txt     ← 喂给 LLM 审核的文件
├── candidate_config.yaml
└── route_recommendation.txt</div>

  <h3>① auto_discover_geo.py — GEO 数据集自动发现</h3>
  <div class="step">
    <span class="step-title">功能：给定疾病名，自动搜索 GEO 找到适合的表达谱数据集</span>
    <div class="step-desc">
      纯规则引擎，无需 LLM。通过 NCBI E-utilities 搜索 → 硬编码过滤（物种/类型/样本数）→ 正则匹配 case/control → 打分排名 → 输出 top-K 候选 → 自动输出路线推荐。
    </div>
    <div class="io">
      <b>单个疾病：</b><code>python auto_discover_geo.py --disease "heart failure" --write-yaml</code><br>
      <b>批量模式：</b><code>python auto_discover_geo.py --batch disease_list_day1_origin.txt --write-yaml</code><br>
      <b>过滤规则：</b>Human only, expression profiling, ≥6 samples, 排除 cell line/animal/miRNA/methylation<br>
      <b>打分维度：</b>样本数(30分) + 平衡性(20分) + 平台质量(20分) + 分类置信度(20分) + 时效性(10分)<br>
      <b>路线推荐：</b>0 GSE → 只走 B | 1 GSE → A 低可信度 | 2-3 → A 可用 | ≥4 → A 理想
    </div>
    <span class="tag tag-api">NCBI E-utilities</span>
    <span class="tag tag-py">Python 纯规则</span>
    <span class="tag tag-out">candidates.tsv + selected.tsv + candidate_config.yaml + route_recommendation.txt</span>
  </div>

  <h3>② AI 辅助审核 — 用 LLM 验证 GSE 质量（2026-02-16 新增）</h3>
  <div class="step">
    <span class="step-title">功能：把 discovery_log.txt 喂给 Claude/ChatGPT，自动检查 GSE 数据集质量</span>
    <div class="step-desc">
      auto_discover_geo 的规则引擎可以过滤大部分不合格数据集，但仍有漏网之鱼（如 16S rRNA 被当作表达谱、PAH 被混入高血压搜索结果）。
      AI 审核能发现规则引擎遗漏的 6 类问题，审核后编辑 YAML 移除不合格 GSE。
    </div>
    <div class="io">
      <b>输入：</b><code>ops/geo_curation/&lt;disease&gt;/discovery_log.txt</code><br>
      <b>操作：</b>复制内容给 LLM，问"请审核这些 GSE 选择"<br>
      <b>审核后：</b>编辑 <code>dsmeta_signature_pipeline/configs/&lt;disease&gt;.yaml</code>：
      <ul style="margin:4px 0 4px 18px;font-size:12px;">
        <li>从 <code>geo.gse_list</code> 删掉不合格 GSE ID</li>
        <li>从 <code>labeling.regex_rules</code> 删掉对应标注块</li>
        <li>审核后 GSE &lt; 2 → 从 <code>disease_list_day1_dual.txt</code> 移除该疾病</li>
      </ul>
    </div>
    <table style="font-size:12px;margin-top:6px;">
      <tr><th>检查项</th><th>不合格 → 移除</th><th>实际案例</th></tr>
      <tr><td>数据类型</td><td>非 mRNA 表达谱</td><td>GSE242047 = 16S rRNA</td></tr>
      <tr><td>疾病匹配</td><td>GSE 研究的是其他疾病</td><td>hypertension 搜到 PAH</td></tr>
      <tr><td>组织/细胞</td><td>细胞系、成纤维细胞</td><td>GSE133754 = 成纤维细胞</td></tr>
      <tr><td>Case/Control</td><td>regex 匹配错误分组</td><td>比较亚型而非 disease vs healthy</td></tr>
      <tr><td>重复</td><td>同一数据集出现两次</td><td>'48060' = GSE48060</td></tr>
      <tr><td>研究设计</td><td>非 case-control 转录组</td><td>GSE220865 = 效力测试</td></tr>
    </table>
    <span class="tag tag-py">Claude / ChatGPT</span>
    <span class="tag tag-out">审核后的 YAML (移除不合格 GSE)</span>
  </div>

  <h3>③ generate_dsmeta_configs.py — 批量生成 dsmeta 配置</h3>
  <div class="step">
    <span class="step-title">功能：从 GEO 发现结果批量生成 dsmeta YAML 配置文件</span>
    <div class="step-desc">
      读取 auto_discover_geo 输出的 selected.tsv，套用标准模板生成完整 dsmeta config。含 TODO 占位符的配置需人工审核。可选自动更新 disease_list_day1_dual.txt（仅 ≥2 GSE 且无 TODO 的疾病会被加入）。输出分类汇总：✅ Ready / ⚠️ Low Confidence / 🔧 Needs Review / ❌ Direction B Only。
    </div>
    <div class="io">
      <b>用法：</b><code>python generate_dsmeta_configs.py --geo-dir geo_curation --config-dir ../dsmeta_signature_pipeline/configs --update-disease-list</code><br>
      <b>DRY RUN：</b><code>python generate_dsmeta_configs.py --geo-dir geo_curation --config-dir ... --dry-run</code>
    </div>
    <span class="tag tag-py">Python</span>
    <span class="tag tag-out">dsmeta configs + disease_list_day1_dual.txt</span>
  </div>

  <h3>④ start.sh — 一键启动</h3>
  <div class="step">
    <span class="step-title">功能：环境检查 + venv安装 + GEO发现 + 配置生成 + 管线启动</span>
    <div class="step-desc">
      整合了整个启动流程。支持子命令模式：<code>check</code>（仅检查）、<code>setup</code>（仅安装）、<code>discover</code>（仅GEO发现）、<code>start</code>（仅启动）、<code>run &lt;disease&gt;</code>（跑单个疾病）、<code>status</code>（查看状态）、<code>results</code>（查看结果）。
    </div>
    <div class="io">
      <b>完整流程：</b><code>bash ops/start.sh</code><br>
      <b>仅检查：</b><code>bash ops/start.sh check</code><br>
      <b>跑单个疾病：</b><code>bash ops/start.sh run atherosclerosis</code><br>
      <b>指定模式：</b><code>bash ops/start.sh start --mode dual</code>
    </div>
    <span class="tag tag-r">Bash</span>
  </div>

  <h3>⑤ check_status.sh — 管线状态监控</h3>
  <div class="step">
    <span class="step-title">功能：一键查看管线运行状态、失败原因、Ollama 健康度、磁盘占用</span>
    <div class="step-desc">
      管线跑起来后，随时可以用这个工具检查每个疾病的运行状态。支持 6 种模式：全局概览、单个疾病详情、失败记录、最近一轮、Ollama 状态、磁盘占用。
    </div>
    <div class="io">
      <b>全局概览：</b><code>bash ops/check_status.sh</code><br>
      <b>单个疾病：</b><code>bash ops/check_status.sh coronary_artery_disease</code><br>
      <b>只看失败：</b><code>bash ops/check_status.sh --failures</code><br>
      <b>Ollama 状态：</b><code>bash ops/check_status.sh --ollama</code><br>
      <b>磁盘占用：</b><code>bash ops/check_status.sh --disk</code><br>
      <b>全部检查：</b><code>bash ops/check_status.sh --all</code>
    </div>
    <span class="tag tag-r">Bash</span>
  </div>

  <h3>启动决策树</h3>
  <div class="highlight">
    <b>第一次跑？</b> → <code>bash ops/start.sh setup</code> 装环境 → <code>bash ops/start.sh start</code> 启动<br>
    <b>只跑 Direction B？</b> → <code>bash ops/start.sh start --mode origin_only</code><br>
    <b>只跑一个疾病试试？</b> → <code>bash ops/start.sh run atherosclerosis</code><br>
    <b>只跑 Cross (ARCHS4)?</b> → <code>SIG_PRIORITY=archs4 bash ops/start.sh run myocarditis --mode cross_only</code><br>
    <b>想加新疾病？</b> → 在 disease list 加一行（填好 disease_key、disease_query、EFO ID）→ <code>bash ops/start.sh start</code>（全自动：GEO→dsmeta→ARCHS4 fallback）<br>
    <b>想精细控制 GSE 选择？</b> → <code>auto_discover_geo.py</code> → AI 审核 → 编辑 YAML → <code>generate_dsmeta_configs.py</code><br>
    <b>跑出问题了？</b> → <code>bash ops/check_status.sh --failures</code>（看哪个疾病的哪个阶段失败）
  </div>

  <h3>当前状态速查</h3>
  <table>
    <tr><th>疾病列表</th><th>内容</th><th>可用模式</th></tr>
    <tr><td><code>disease_list_day1_origin.txt</code></td><td>15 个心血管疾病 (有 EFO ID)</td><td>Direction B (origin_only)</td></tr>
    <tr><td><code>disease_list_day1_dual.txt</code></td><td>7 个疾病 (atherosclerosis + 6 auto-discovered, AI 审核后 ≥2 GSE)</td><td>Direction A + B (dual)</td></tr>
    <tr><td><code>disease_list.txt</code></td><td>模板/空</td><td>自定义</td></tr>
  </table>

  <div class="highlight-green">
    <b>🆕 新增疾病（全自动模式，推荐）：</b><br>
    ① 在 disease list 加一行：<code>peripheral_artery_disease|peripheral artery disease|EFO_0004265|</code><br>
    ② <code>bash ops/start.sh start</code> → runner 自动执行 ensure_cross_signature_config()：<br>
    &nbsp;&nbsp;&nbsp;&nbsp;→ 搜 GEO → 生成 dsmeta config → GEO 失败则生成 ARCHS4 config → 都失败则 skip Cross 继续 Origin<br>
    ③ 完毕。无需手动创建任何 config 文件。
  </div>
  <div class="highlight-pink">
    <b>新增疾病（精细控制模式，可选）：</b><br>
    ① <code>auto_discover_geo.py --disease "xxx" --write-yaml</code> → 搜 GEO + 自动分类<br>
    ② 查看 <code>geo_curation/xxx/route_recommendation.txt</code> → 确认路线（0 GSE = 只走 B，≥2 GSE = 可走 A）<br>
    ③ <b style="color:#d63384;">AI 审核</b>：把 <code>discovery_log.txt</code> 喂给 Claude/ChatGPT → 检查数据类型/疾病匹配/组织/regex/重复/设计<br>
    ④ 编辑 <code>configs/xxx.yaml</code> → 从 gse_list 和 regex_rules 移除不合格 GSE（审核后 &lt;2 GSE → 移除该疾病）<br>
    ⑤ <code>generate_dsmeta_configs.py --update-disease-list</code> → 生成 config + 更新列表（仅 ≥2 GSE）<br>
    ⑥ <code>bash ops/start.sh check --mode dual</code> → 验证环境和 config 能跑通<br>
    ⑦ 重启 runner 或等下一轮自动 pick up
  </div>

  <div class="highlight">
    <b>GSE 数量与路线决策：</b><br>
    <b>0 GSE</b> → ❌ 跳过 Direction A，只走 Direction B（CT.gov → KG → LLM）<br>
    <b>1 GSE</b> → ⚠️ Direction A 低可信度（无跨实验验证），建议手动补搜或只走 B<br>
    <b>2-3 GSE</b> → ✅ Direction A 可用，meta-analysis 有效<br>
    <b>3-5 GSE</b> → ✅ Direction A 理想，最佳性价比<br>
    <b>>5 GSE</b> → ✅ 充足，可更严格筛选
  </div>

</div>

<!-- ==================== 完整数据流 ==================== -->
<div id="dataflow"></div>
<h2>8. 完整数据流 &amp; 关键文件</h2>
<div class="card">

  <h3>端到端数据流（完整版）</h3>
<div class="flow" style="font-size:10px; line-height: 1.7;">    ┌──────────────────────────┐   ┌─────────────────────────────┐
    │     GEO 数据集           │   │   ARCHS4 H5 全平台          │
    │  GSE28829, GSE43292 ...  │   │   human_gene_v2.4.h5        │
    └────────────┬─────────────┘   └──────────────┬──────────────┘
                 │                                 │
  ══════════════╪══ 模块 1a: dsmeta    ══════════╪══ 模块 1b: ARCHS4
                 ▼                                 ▼
      Step1-3: 下载→limma DE→探针→基因   Step1-2: 关键词搜索→样本提取
                 │                                 │
                 ▼                                 ▼
      Step4-5: meta 分析+RRA 排名        Step3-5: DESeq2→meta→签名
                 │                                 │
                 └──────────────┬──────────────────┘
                                │ SIG_PRIORITY 选择
                                ▼
                 ┌──────────────────────────────────┐
                 │  签名质量门控 (模块 1c)           │
                 │  total≥30 &amp; min(up,down)≥10     │
                 │  Tier0: 跳过 / Tier1: cap80      │
                 │  Tier2: cap200 (默认)             │
                 └──────────────┬───────────────────┘
                                │ sigreverse_input.json
                                ▼
        ════════════════════════╪════════════════ 模块 2: SigReverse
                                 ▼
                    Step1-4: LINCS L1000 查询 + 元数据
                                 │
                                 ▼
                    Step5-8: WTCS 打分 → 聚合 → 置换检验 → Tau
                                 │
                                 ▼
                   ┌───────────────────────────┐
                   │  drug_reversal_rank.csv   │
                   │  (候选药物反转分数排名)      │
                   └─────────────┬─────────────┘
                                 │
        ═════════════════════════╪═══════════════ 模块 3: kg_explain
                                 ▼
                    Step1-5: 药物→靶点映射
                    (CT.gov模式 or 签名模式)
                                 │
                                 ▼
                    Step6-10: 靶点→通路→疾病 + FAERS + 表型
                                 │
                                 ▼
                    V5 排名: 54,000+ 药物-疾病对
                                 │
                    ┌────────────┴────────────┐
                    │                         │
                    ▼                         ▼
  ┌──────────────────────────┐  ┌──────────────────────────┐
  │ bridge_repurpose_cross   │  │ bridge_origin_reassess   │
  │ 每药全局最优疾病 (~50药)  │  │ 仅目标疾病行 (~83药)     │
  └────────────┬─────────────┘  └────────────┬─────────────┘
               │                              │
        ═══════╪══════════════════════════════╪══ 模块 4: LLM+RAG
               │                              │
               ▼                              ▼
  ┌──────────────────────┐      ┌──────────────────────┐
  │   Direction A        │      │   Direction B        │
  │   跨疾病迁移          │      │   原疾病重评估        │
  │                      │      │                      │
  │  Step6: PubMed+LLM  │      │  Step6: PubMed+LLM  │
  │  Step7: 5维打分+门控  │      │  Step7: 5维打分+门控  │
  │  Step8: 候选打包      │      │  Step8: 候选打包      │
  │  Step9: 验证方案      │      │  Step9: 验证方案      │
  └──────────┬───────────┘      └──────────┬───────────┘
             │                              │
             ▼                              ▼
  ┌──────────────────────┐      ┌──────────────────────┐
  │ 跨疾病候选清单        │      │ 原疾病候选清单        │
  │ fusion_rank_report.xlsx  │      │ fusion_rank_report.xlsx  │
  │ validation_plan.csv  │      │ validation_plan.csv  │
  │ (~5 个 GO 候选)      │      │ (~10 个 GO 候选)     │
  └──────────────────────┘      └──────────────────────┘
             │                              │
             └──────────┬───────────────────┘
                        ▼
               研究者综合决策
            选择最终验证候选药物</div>

  <h3>关键文件清单</h3>
  <table>
    <tr><th>文件</th><th>产自</th><th>交给</th><th>内容</th></tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">sigreverse_input.json</td>
      <td>dsmeta / ARCHS4</td><td>SigReverse</td>
      <td>N up + N down 基因签名 (dsmeta: 300+300, ARCHS4: 视样本量)</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">disease_signature_meta.json</td>
      <td>dsmeta / ARCHS4</td><td>kg_explain (signature mode)</td>
      <td>签名元数据 (基因列表+权重+来源信息)</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">drug_reversal_rank.csv</td>
      <td>SigReverse</td><td>kg_explain (可选融合)</td>
      <td>药物反转分数排名</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">drug_disease_rank.csv</td>
      <td>kg_explain</td><td>内部使用</td>
      <td>54K+ 药物-疾病对的综合得分</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;color:#e84393;">bridge_repurpose_cross.csv</td>
      <td>kg_explain</td><td>LLM+RAG Dir A</td>
      <td>~50 药物（全局最优疾病）+ 靶点/结构信息</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;color:#00b894;">bridge_origin_reassess.csv</td>
      <td>kg_explain</td><td>LLM+RAG Dir B</td>
      <td>~83 药物（目标疾病得分）+ 靶点/结构信息</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">step7_gating_decision.csv</td>
      <td>LLM+RAG</td><td>Step 8</td>
      <td>GO / MAYBE / NO-GO 决策</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">fusion_rank_report.xlsx</td>
      <td>LLM+RAG</td><td>最终交付</td>
      <td>Excel 报告 (总表+详情+靶点结构表)</td>
    </tr>
    <tr>
      <td style="font-family:monospace;font-size:11px;">validation_plan.csv</td>
      <td>LLM+RAG</td><td>最终交付</td>
      <td>实验验证方案 (P1/P2/P3)</td>
    </tr>
  </table>
</div>

<!-- ==================== 综合打分架构 ==================== -->
<div id="scoring"></div>
<h2 style="background: linear-gradient(135deg, #e17055, #fdcb6e);">9. 综合打分架构</h2>
<div class="card">
  <p class="section-intro">最终排名不是单一模块决定的，而是 <b>3 个模块的评分串行传递 + 融合</b>。每个模块独立打分，分数沿管线向下传递，最终在 Step 8 的 rank_key 汇合。</p>

  <h3>实际打分流程（runner.sh 标准管线）</h3>
<div class="flow-light">
━━━━━━━━━━━━━━━━━  第 1 层：模块独立打分  ━━━━━━━━━━━━━━━━━

  Cross 路线                              Origin 路线
  ─────────                              ─────────
  dsmeta / ARCHS4                        screen_drugs (CT.gov)
       │                                       │
       ▼                                       │
┌─────────────────────────┐                    │
│  SigReverse             │                    │
│  WTCS 签名反转打分       │                    │
│  更负 = 更强反转 = 更好  │                    │
│  OUT: reversal_rank.csv │                    │
└───────────┬─────────────┘                    │
            │                                  │
            ▼                                  ▼
┌──────────────────────────────────────────────────────────┐
│  kg_explain V5 排名                                      │
│                                                          │
│  base: DTPD 路径 → mechanism_score                       │
│        (pathway_score × hub_penalty × affinity_weight)   │
│        + diversity_bonus (多路径/多靶点)                   │
│                                                          │
│  final = mechanism_score                                 │
│        × exp(-0.3 × safety_penalty - 0.2 × trial_penalty)│
│        × (1 + 0.1 × phenotype_boost)                    │
│                                                          │
│  安全罚: tanh(log1p(PRR)/5 × confidence × serious_wt)    │
│  试验罚: 0.1 × log1p(safety_stops) + 0.05 × log1p(eff)  │
│  表型:   avg_pheno_score × log1p(n_phenotype)            │
│                                                          │
│  组合药: final_score /= 成分数 (归一化，避免膨胀)          │
│  Bootstrap CI 1000x 量化不确定性                          │
│                                                          │
│  OUT: drug_disease_rank.csv (54K+ 对)                    │
└──────────┬──────────────────────────────────┬────────────┘
           │                                  │
           ▼                                  ▼
┌────────────────────────┐     ┌────────────────────────┐
│ bridge_repurpose_cross │     │ bridge_origin_reassess │
│ 每药全局最优疾病 (~50)  │     │ 仅目标疾病行 (~83)     │
│ 含: final_score,       │     │ 含: final_score,       │
│ 靶点/PDB/AlphaFold     │     │ 靶点/PDB/AlphaFold     │
└───────────┬────────────┘     └───────────┬────────────┘
            │                               │
━━━━━━━━━━━━╪═══════════════════════════════╪━━━━ A/B 交叉验证
            │                               │
            │     compare_ab_routes.py       │
            │     (bridge 层级比较)           │
            │     sort = n_routes × 2.0      │
            │         + max(score_a, score_b) │
            │     A+B 都有 → 最高置信度       │
            │     OUT: ab_comparison.csv      │
            │                               │
━━━━━━━━━━━━╪═══════════════════════════════╪━━━━ 第 2 层：文献打分 + 融合
            │                               │
            ▼                               ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│  Step 6: PubMed RAG      │  │  Step 6: PubMed RAG      │
│  多路检索 + 语义重排      │  │  多路检索 + 语义重排      │
│  + LLM 结构化提取         │  │  + LLM 结构化提取         │
└────────────┬─────────────┘  └────────────┬─────────────┘
             ▼                              ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│  Step 7: 5 维打分 (0-100) │  │  Step 7: 5 维打分 (0-100) │
│  证据强度  0-30           │  │  证据强度  0-30           │
│  机制合理性 0-20          │  │  机制合理性 0-20          │
│  可转化性  0-20           │  │  可转化性  0-20           │
│  安全性    0-20           │  │  安全性    0-20           │
│  可行性    0-10           │  │  可行性    0-10           │
│                          │  │                          │
│  门控: ≥60→GO            │  │  门控: ≥60→GO            │
│       40-60→MAYBE        │  │       40-60→MAYBE        │
│       &lt;40→NO-GO          │  │       &lt;40→NO-GO          │
│  硬门控: benefit&lt;1       │  │  硬门控: benefit&lt;1       │
│    / 文献&lt;2 / 危害&gt;50%   │  │    / 文献&lt;2 / 危害&gt;50%   │
└────────────┬─────────────┘  └────────────┬─────────────┘
             ▼                              ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│  Step 8: rank_key 融合   │  │  Step 8: rank_key 融合   │
│  ★ 真正的多源融合点       │  │  ★ 真正的多源融合点       │
│                          │  │                          │
│  rank_key =              │  │  rank_key =              │
│    min(30, log1p(pmid)   │  │    min(30, log1p(pmid)   │
│         × 10)  文献量     │  │         × 10)  文献量     │
│  + topic_match × 5       │  │  + topic_match × 5       │
│  + LLM_score × 0.35      │  │  + LLM_score × 0.35      │
│     ↑ 来自 Step7 5维总分  │  │     ↑ 来自 Step7 5维总分  │
│  + novelty × 19.5        │  │  + novelty × 15          │
│     (cross 鼓励探索)      │  │                          │
│  - uncertainty × 4       │  │  - uncertainty × 4       │
│  - harm_count × 0.5      │  │  - harm_count × 0.5      │
│  - neg_trials × 1        │  │  - neg_trials × 1        │
│  - blacklist_hit × 8     │  │  - blacklist_hit × 8     │
│                          │  │                          │
│  GO 优先排序              │  │  GO 优先排序              │
│  + explore 通道 MAYBE     │  │  + explore 通道 MAYBE     │
└────────────┬─────────────┘  └────────────┬─────────────┘
             ▼                              ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│  Step 9: 验证方案生成     │  │  Step 9: 验证方案生成     │
│  P1/P2/P3 优先级          │  │  P1/P2/P3 优先级          │
└──────────────────────────┘  └──────────────────────────┘
             │                              │
             ▼                              ▼
  fusion_rank_report.xlsx ×2 → 研究者综合决策</div>

  <h3>各层打分公式速查</h3>
  <table>
    <tr><th>层级</th><th>模块</th><th>核心公式</th><th>分数方向</th></tr>
    <tr>
      <td><b>L1a</b></td>
      <td style="color:#34c759;">SigReverse</td>
      <td><code>WTCS = (z_up + z_down) / 2</code> &times; confidence_weight<br>部分一致: &times;0.3 衰减；聚合: weighted_median + cell_line diversity bonus</td>
      <td>更负 = 更好</td>
    </tr>
    <tr>
      <td><b>L1b</b></td>
      <td style="color:#ff9500;">kg_explain V5</td>
      <td><code>final = mechanism &times; exp(-0.3&times;safety - 0.2&times;trial) &times; (1 + 0.1&times;pheno)</code><br>
      safety: <code>tanh(log1p(PRR)/5 &times; conf &times; serious_wt)</code><br>
      trial: <code>0.1&times;log1p(safe_stops) + 0.05&times;log1p(eff_stops)</code><br>
      pheno: <code>avg_pheno_score &times; log1p(n_pheno)</code></td>
      <td>更高 = 更好</td>
    </tr>
    <tr>
      <td><b>Bridge</b></td>
      <td style="color:#636e72;">compare_ab</td>
      <td><code>sort_key = n_routes &times; 2.0 + max(score_a, score_b)</code><br>
      A+B 双线 &rarr; +4 加成（bridge 层级，早期参考）</td>
      <td>更高 = 更好</td>
    </tr>
    <tr>
      <td><b>L2a</b></td>
      <td style="color:#af52de;">LLM+RAG 5维</td>
      <td>证据强度(30) + 机制(20) + 转化(20) + 安全(20) + 可行(10) = 0-100<br>
      硬门控: benefit&lt;1 / 文献&lt;2 / 危害&gt;50% → NO-GO<br>
      软门控: &ge;60→GO / 40-60→MAYBE / &lt;40→NO-GO</td>
      <td>更高 = 更好</td>
    </tr>
    <tr>
      <td><b>L2b ★</b></td>
      <td style="color:#e84393;">Step8 rank_key</td>
      <td><code>min(30, log1p(pmid)&times;10) + topic&times;5 + LLM_score&times;0.35 + novelty&times;15~19.5<br>- uncertainty&times;4 - harm&times;0.5 - neg_trials&times;1 - blacklist&times;8</code><br>
      GO 优先 + explore 通道 → <b>★ 各模块分数在这里汇合为最终排名</b></td>
      <td>更高 = 更好</td>
    </tr>
  </table>

  <div class="highlight-green">
    <b>备用：FusionRanker (sigreverse/fusion.py)</b><br>
    代码已实现但<b>标准管线默认关闭</b>（<code>fusion.enabled: false</code>）。<br>
    公式: <code>fusion = 0.50&times;norm(sig) + 0.30&times;norm(kg) + 0.10&times;norm(safety) + synergy + DR + lit</code><br>
    可手动开启: 在 <code>sigreverse/configs/default.yaml</code> 设 <code>fusion.enabled: true</code> + 配置 kg_scores_path。<br>
    启用后会在 SigReverse 管线内额外输出 <code>fusion_ranking.csv</code>。
  </div>

  <h3>关键设计决策</h3>
  <div class="highlight">
    <b>为什么是串行传递而不是一个大公式？</b><br>
    &bull; 各模块<b>数据来源完全不同</b>（LINCS 表达谱 vs ChEMBL 靶点 vs PubMed 文献），量纲不可比<br>
    &bull; SigReverse 筛出候选药 → kg_explain 解释机制 + 安全/试验/表型调整 → bridge 传递给 LLM+RAG<br>
    &bull; LLM+RAG 提供<b>独立的文献验证</b>——算法说好不够，文献也要支持<br>
    &bull; <b>Step 8 rank_key 是真正的融合点</b>：文献量 + LLM 5维总分 + novelty - 各项罚分<br>
    &bull; LLM_score 权重被刻意压低到 <b>&times;0.35</b>（原 &times;1.0 导致 65% 权重，偏向"好讲故事"的药）<br>
    &bull; A/B 交叉验证是<b>额外的独立性检验</b>——两条独立路线都找到 = 最高置信
  </div>
</div>

<!-- ==================== 速查表 ==================== -->
<div id="summary"></div>
<h2>10. 速查总结</h2>
<div class="card">

  <h3>各模块一句话总结</h3>
  <table>
    <tr><th>模块</th><th>做什么</th><th>核心产出</th></tr>
    <tr><td style="color:#0071e3;font-weight:600;">dsmeta</td><td>多 GSE meta 分析 → 疾病基因签名</td><td>300 up + 300 down 基因</td></tr>
    <tr><td style="color:#0071e3;font-weight:600;">ARCHS4</td><td>H5 全平台关键词搜索 → DESeq2 → 签名</td><td>N up + N down 基因 (按样本覆盖)</td></tr>
    <tr><td style="color:#e84393;font-weight:600;">质量门控</td><td>min(up,down)&ge;10 &amp; total&ge;30 → 分层 cap</td><td>Tier 0/1/2 决策 + 药物上限</td></tr>
    <tr><td style="color:#34c759;font-weight:600;">SigReverse</td><td>签名反转查 LINCS → 候选药物</td><td>反转分数排名表</td></tr>
    <tr><td style="color:#ff9500;font-weight:600;">kg_explain</td><td>Drug→Target→Pathway→Disease 解释</td><td>V5 排名 + 2 个 bridge 文件 (含靶点/PDB/AlphaFold)</td></tr>
    <tr><td style="color:#af52de;font-weight:600;">LLM+RAG</td><td>PubMed 文献证据 + 打分门控</td><td>2 份候选清单 (含靶点结构表) + 验证方案</td></tr>
  </table>

  <h3>关键外部 API</h3>
  <table>
    <tr><th>API</th><th>用途</th><th>模块</th></tr>
    <tr><td>NCBI GEO</td><td>基因表达数据</td><td>dsmeta</td></tr>
    <tr><td>ARCHS4 H5</td><td>RNA-seq 表达矩阵 (本地 H5 文件)</td><td>archs4_signature</td></tr>
    <tr><td>NCBI E-utilities</td><td>GEO 数据集自动发现</td><td>ops/auto_discover_geo</td></tr>
    <tr><td>LDP3 (LINCS)</td><td>药物基因表达签名</td><td>SigReverse</td></tr>
    <tr><td>ClinicalTrials.gov</td><td>临床试验</td><td>kg_explain, LLM+RAG</td></tr>
    <tr><td>ChEMBL</td><td>药物-靶点-机制</td><td>kg_explain</td></tr>
    <tr><td>Reactome</td><td>生物通路</td><td>kg_explain</td></tr>
    <tr><td>OpenTargets</td><td>基因-疾病关联</td><td>kg_explain</td></tr>
    <tr><td>RxNorm</td><td>药物名标准化</td><td>kg_explain</td></tr>
    <tr><td>FAERS</td><td>不良反应</td><td>kg_explain</td></tr>
    <tr><td>PubMed (NCBI)</td><td>文献摘要</td><td>LLM+RAG</td></tr>
    <tr><td>Ollama (本地)</td><td>LLM 结构化提取</td><td>LLM+RAG</td></tr>
  </table>

  <h3>一句话理解整个项目</h3>
  <div class="highlight">
    从公共基因表达数据构建疾病签名（dsmeta GEO meta 分析 或 ARCHS4 H5 全平台搜索，含分层质量门控）→ 用 LINCS 反查候选药物 → 用知识图谱解释机制并分裂为"跨疾病探索"和"原疾病重评估"两条路线 → 用 PubMed + LLM 为每条路线独立生成文献证据和验证方案 → 研究者综合两份清单做最终决策。
  </div>

</div>

<div class="card-full" style="text-align:center; color:#86868b; font-size:12px; margin-top:24px;">
  Drug Repurposing Platform &middot; 项目全览 v5<br>
  更新于 2026-02-26 &middot; 新增：综合打分架构 + Cross 路线全自动化 + V5 打分公式更新 (PRR-based tanh + log-saturating trial)
</div>

</body>
</html>
